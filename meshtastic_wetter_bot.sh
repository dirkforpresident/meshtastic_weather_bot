#!/bin/bash

# Bash-Skript f√ºr automatisierte Wetter- und Systemmeldungen √ºber Meshtastic
# Sendet st√ºndlich Wetterdaten (Temperatur, Wettercode, Windgeschwindigkeit) f√ºr Hamburg (53.350000, 10.030000) √ºber einen per USB angeschlossenen Meshtastic-Node (Main Channel, Index 0)
# Nutzt Open-Meteo f√ºr Wetterdaten und lm-sensors f√ºr CPU-Temperatur
# Protokollierung in /tmp/wetterbot.log und /tmp/wetterbot_debug.log
# Format: [$UHRZEIT] [$LAUNE_EMOJI] [$LAUNE] $WEATHER_EMOJI Hamburg: TEMP¬∞C $TREND $SWEAT_EMOJI [$TREND_JOKE] - $HARDWARE_JOKE/$WEATHER_JOKE [$CPU: TEMP¬∞C ‚ö†Ô∏è üî• $CPU_JOKE]

# Exit bei Fehlern
set -e

# Konfiguration
LOG_FILE="/tmp/wetterbot.log"
LAST_TEMP_FILE="/tmp/last_temp.txt"
DEBUG_FILE="/tmp/wetterbot_debug.log"
DEBUG=1 # Debugging aktiviert
MESHTASTIC_PORT="/dev/ttyUSB0"

# Pfad f√ºr meshtastic CLI
export PATH="$PATH:$HOME/.local/bin"

# --- 1. Uhrzeit und Wochenende ---
TIMESTAMP=$(date "+%Y-%m-%d %H:%M:%S")
HOUR=$(date "+%H")
DAY=$(date "+%u")
UHRZEIT=$(date "+%H:%M")

# Nacht (22:00-05:59)?
if [ "$HOUR" -ge 22 ] || [ "$HOUR" -lt 6 ]; then
    TIME="Nacht"
else
    TIME="Tag"
fi

# Wochenende (Sa/So) oder Montag vormittag (Mo, 00:00-11:59)?
if [ "$DAY" -ge 6 ]; then
    WEEKEND="WE"
    LAUNE_STATE="Wochenende"
elif [ "$DAY" -eq 1 ] && [ "$HOUR" -lt 12 ]; then
    WEEKEND="WT"
    LAUNE_STATE="MontagVormittag"
else
    WEEKEND="WT"
    LAUNE_STATE="KeinLaune"
fi

# --- 2. CPU-Temperatur ---
if command -v sensors >/dev/null 2>&1; then
    CPU_TEMP=$(sensors | grep 'Package id 0:' | awk '{print $4}' | tr -d '+¬∞C')
    if [ -z "$CPU_TEMP" ]; then
        CPU_TEMP="N/A"
        CPU_JOKE_ARRAY=("Sensor kaputt!" "Sensor weg!" "CPU? Keine Ahnung!" "Sensor schl√§ft!" "Temperatur 404!" "Sensor? Wo bist du?" "CPU-Daten? Nope!" "Sensor tot? Argh!" "Sensor? Echt jetzt?" "Daten weg? Mist!" "CPU? Nix los!" "Sensor? Oh, Mann!" "Temperatur? Nada!" "Sensor? Nervig!" "CPU? Kein Plan!" "Daten? Fehlanzeige!" "Sensor? Puh!" "CPU? Verloren!" "Sensor? Argh!" "Temperatur? Hilfe!")
    elif [ $(echo "$CPU_TEMP > 60" | bc) -eq 1 ]; then
        CPU_JOKE_ARRAY=("CPU brennt! L√ºfter her!" "Heisse CPU, auweia!" "CPU gl√ºht, Hilfe!" "L√ºfter, voll Gas!" "CPU wie ‚Äône Sauna!" "CPU heiss? Ich schmelz!" "L√ºfter? Wo bist du?" "CPU kocht, aua!" "Heiss? Echt jetzt?" "CPU? Zu heiss!" "L√ºfter an, schnell!" "CPU brennt? Argh!" "Sauna im Geh√§use!" "Heiss? Oh, Mann!" "CPU gl√ºht? Puh!" "L√ºfter? Echt jetzt?" "CPU? Ich schwitz!" "Heiss? So nervig!" "CPU kocht? Mist!" "L√ºfter her, bitte!")
    else
        CPU_JOKE_ARRAY=("CPU cool!" "CPU chillt!" "Alles klar bei CPU!" "CPU l√§uft entspannt!" "CPU im gr√ºnen Bereich!" "CPU? Alles easy!" "CPU kalt, nice!" "CPU? Kein Stress!" "CPU? Alles gut!" "K√ºhl? Na, super!" "CPU? Relax!" "Alles klar? Yep!" "CPU? Chillen!" "Kalt? Perfekt!" "CPU? No Problem!" "Cool? Oh, yeah!" "CPU? Entspannt!" "K√ºhl? Echt nice!" "CPU? Alles klar!" "CPU? Null Stress!")
    fi
    CPU_JOKE=${CPU_JOKE_ARRAY[$((RANDOM % ${#CPU_JOKE_ARRAY[@]}))]}
else
    CPU_TEMP="N/A"
    CPU_JOKE_ARRAY=("Sensor kaputt!" "Sensor weg!" "CPU? Keine Ahnung!" "Sensor schl√§ft!" "Temperatur 404!" "Sensor? Wo bist du?" "CPU-Daten? Nope!" "Sensor tot? Argh!" "Sensor? Echt jetzt?" "Daten weg? Mist!" "CPU? Nix los!" "Sensor? Oh, Mann!" "Temperatur? Nada!" "Sensor? Nervig!" "CPU? Kein Plan!" "Daten? Fehlanzeige!" "Sensor? Puh!" "CPU? Verloren!" "Sensor? Argh!" "Temperatur? Hilfe!")
    CPU_JOKE=${CPU_JOKE_ARRAY[$((RANDOM % ${#CPU_JOKE_ARRAY[@]}))]}
fi

# CPU-Warnungssymbol
if [ "$CPU_TEMP" != "N/A" ] && [ $(echo "$CPU_TEMP > 60" | bc) -eq 1 ]; then
    CPU_TEMP_STR="CPU: $CPU_TEMP¬∞C ‚ö†Ô∏è"
else
    CPU_TEMP_STR="CPU: $CPU_TEMP¬∞C"
fi

# --- 3. Wetter von Open-Meteo (Hamburg: 53.350000, 10.030000) ---
WEATHER_URL="https://api.open-meteo.com/v1/forecast?latitude=53.350000&longitude=10.030000¬§t=temperature_2m,weathercode,wind_speed_10m"
WEATHER=$(curl -s --connect-timeout 3 --retry 2 "$WEATHER_URL" 2>>"$DEBUG_FILE" || echo "ERROR")
if [ "$DEBUG" -eq 1 ]; then
    echo "[$TIMESTAMP] API Response: $WEATHER" >> "$DEBUG_FILE"
fi
if [ "$WEATHER" = "ERROR" ] || [ -z "$WEATHER" ] || ! echo "$WEATHER" | jq . >/dev/null 2>&1; then
    CURRENT_TEMP="N/A"
    WEATHER_CODE="99"
    WIND_SPEED="0"
    WEATHER_EMOJI="üåê"
    SWEAT_EMOJI=""
    WEATHER_JOKE_ARRAY=("Kein Netz! Mist!" "Wetter offline!" "Internet weg!" "Daten im Wind!" "Netz? Fehlanzeige!" "Kein Signal? Argh!" "WLAN tot? Echt?" "Netz weg, ich heul!" "Internet? Nope!" "Signal? Fehlanzeige!" "Netz tot? Boah!" "WLAN? Oh, Mann!" "Kein Netz? Puh!" "Daten weg? Mist!" "Internet? Argh!" "Signal? Nada!" "Netz? Echt jetzt?" "WLAN? Kaputt!" "Kein Netz? Nervig!" "Internet? Hilfe!")
    WEATHER_JOKE=${WEATHER_JOKE_ARRAY[$((RANDOM % ${#WEATHER_JOKE_ARRAY[@]}))]}
    HARDWARE_JOKE=""
    TEMP_BASE="Hamburg: $CURRENT_TEMP¬∞C"
else
    CURRENT_TEMP=$(echo "$WEATHER" | jq '.current.temperature_2m' 2>/dev/null || echo "N/A")
    WEATHER_CODE=$(echo "$WEATHER" | jq '.current.weathercode' 2>/dev/null || echo "99")
    WIND_SPEED=$(echo "$WEATHER" | jq '.current.wind_speed_10m' 2>/dev/null || echo "0")
    if [ "$DEBUG" -eq 1 ]; then
        echo "[$TIMESTAMP] Wettercode: $WEATHER_CODE, Windgeschwindigkeit: $WIND_SPEED km/h" >> "$DEBUG_FILE"
    fi
    TEMP_BASE="Hamburg: $CURRENT_TEMP¬∞C"
    if [ "$CURRENT_TEMP" != "N/A" ]; then
        if [ $(echo "$CURRENT_TEMP > 36" | bc) -eq 1 ]; then
            SWEAT_EMOJI="ü•µ"
            HARDWARE_JOKE_ARRAY=("L√ºfter schreit um Hilfe!" "CPU will ‚Äônen Eisw√ºrfel!" "Board kocht, aua!" "Chip brutzelt, Hilfe!" "L√ºfter? Vollgas!" "CPU? Sauna-Modus!" "RAM gl√ºht, Puh!" "Board? Heiss wie Lava!" "Chip? Schmelz-Alarm!" "CPU kocht Bits!" "L√ºfter? Echt jetzt?" "Board? Zu heiss!" "CPU? Ich brenn!" "RAM? Sommerhitze!" "Chip? Feueralarm!" "L√ºfter, rette mich!" "CPU? Im Ofen!" "Board schmilzt fast!" "RAM? Zu heiss!" "Chip? Hitzewelle!")
            HARDWARE_JOKE=${HARDWARE_JOKE_ARRAY[$((RANDOM % ${#HARDWARE_JOKE_ARRAY[@]}))]}
        elif [ $(echo "$CURRENT_TEMP >= 30" | bc) -eq 1 ]; then
            SWEAT_EMOJI="üåû"
            HARDWARE_JOKE_ARRAY=("L√ºfter heult laut!" "CPU schwitzt Bits!" "Board? Heiss, Mann!" "Chip? Zu warm!" "L√ºfter? Turbo an!" "CPU? Hitzestress!" "RAM? Warmgelaufen!" "Board? Sommerfeeling!" "Chip? Braucht Eis!" "CPU? Puh, heiss!" "L√ºfter? Voll dran!" "Board? Hitzealarm!" "RAM? Gl√ºht leise!" "CPU? Schwitzt!" "Chip? Hitzewarnung!" "L√ºfter? Schnell!" "Board? Zu warm!" "RAM? Heiss, Hilfe!" "CPU? Sommer!" "Chip? L√ºfter her!")
            HARDWARE_JOKE=${HARDWARE_JOKE_ARRAY[$((RANDOM % ${#HARDWARE_JOKE_ARRAY[@]}))]}
        elif [ $(echo "$CURRENT_TEMP <= 5" | bc) -eq 1 ]; then
            SWEAT_EMOJI="ü•∂"
            HARDWARE_JOKE_ARRAY=("Pi heizt wie ‚Äôn Ofen!" "CPU w√§rmt die Platine!" "Board? Kuschelig!" "Chip? Heizt gut!" "Pi? Winterw√§rmer!" "CPU? Heizmodus!" "RAM? W√§rmt mich!" "Board? Kuschlig kalt!" "Chip? Pi-Heizung!" "CPU? W√§rmt auf!" "Pi? Heizt Hamburg!" "Board? Winterwarm!" "RAM? Heizt leise!" "CPU? K√§lte? Nein!" "Chip? W√§rme an!" "Pi? Heizstrahler!" "Board? Kuschlig!" "RAM? Winterheizung!" "CPU? Heizt gut!" "Chip? Pi w√§rmt!")
            HARDWARE_JOKE=${HARDWARE_JOKE_ARRAY[$((RANDOM % ${#HARDWARE_JOKE_ARRAY[@]}))]}
        else
            SWEAT_EMOJI=""
            if [ $(echo "$CURRENT_TEMP >= 20" | bc) -eq 1 ]; then
                SWEAT_EMOJI="üï∂Ô∏è"
            elif [ $(echo "$CURRENT_TEMP >= 10" | bc) -eq 1 ]; then
                SWEAT_EMOJI="üòä"
            elif [ $(echo "$CURRENT_TEMP >= 0" | bc) -eq 1 ]; then
                SWEAT_EMOJI="ü•∂"
            else
                SWEAT_EMOJI="‚ùÑÔ∏è"
            fi
            HARDWARE_JOKE=""
        fi
    else
        SWEAT_EMOJI=""
        HARDWARE_JOKE=""
    fi
    if [ "$WIND_SPEED" != "0" ] && [ $(echo "$WIND_SPEED >= 40" | bc) -eq 1 ]; then
        WEATHER_EMOJI="üí®"
        HARDWARE_JOKE_ARRAY=("Antenne wackelt im Wind!" "Wind? Antenne h√§lt‚Äôs aus!" "Antenne? Sturm-Tanz!" "CPU? Windresistenz!" "Board? Wackelt im Sturm!" "Chip? Wind-Alarm!" "Antenne? Festhalten!" "RAM? Windb√∂en!" "CPU? Sturm-Panik!" "Board? Windangst!" "Antenne? Wildes Spiel!" "Chip? Sturmmodus!" "RAM? Wackelt mit!" "CPU? Wind, Hilfe!" "Board? Sturm-Party!" "Antenne? Wind-Twist!" "Chip? Wind-Chaos!" "RAM? Sturm-Schock!" "CPU? Windfrei!" "Antenne? Sturm-Spin!")
        HARDWARE_JOKE=${HARDWARE_JOKE_ARRAY[$((RANDOM % ${#HARDWARE_JOKE_ARRAY[@]}))]}
    elif [ "$WEATHER_CODE" -eq 95 ] || [ "$WEATHER_CODE" -eq 96 ] || [ "$WEATHER_CODE" -eq 99 ]; then
        WEATHER_EMOJI="‚ö°Ô∏è"
        HARDWARE_JOKE_ARRAY=("Blitz? Antenne duckt sich!" "Antenne? Gewitter-Panik!" "CPU? Blitzschock!" "Board? Donner, Hilfe!" "Chip? Gewitter-Alarm!" "Antenne? Blitz-Tanz!" "RAM? Donner-Schreck!" "CPU? Versteck dich!" "Board? Blitzangst!" "Chip? Blitz-Chaos!" "Antenne? Gewitter-Wackeln!" "CPU? Blitz, aua!" "RAM? Gewitter-Vibes!" "Board? Donner-Panik!" "Chip? Blitz-Alarm!" "Antenne? Donner-Twist!" "CPU? Gewitter-Funkeln!" "RAM? Blitz-Schock!" "Board? Gewitter-Party!" "Antenne? Blitz-Spin!")
        HARDWARE_JOKE=${HARDWARE_JOKE_ARRAY[$((RANDOM % ${#HARDWARE_JOKE_ARRAY[@]}))]}
    elif [ -z "$HARDWARE_JOKE" ]; then
        if [ "$CURRENT_TEMP" != "N/A" ] && [ $(echo "$CURRENT_TEMP > 30" | bc) -eq 1 ] && [ "$WEATHER_CODE" -le 1 ]; then
            WEATHER_EMOJI="‚òÄÔ∏è"
            WEATHER_JOKE_ARRAY=("Sonne! Sommerfeeling!" "Blauer Himmel, yeah!" "Sonnenbrille raus!" "Sonne lacht, nice!" "Hamburg glitzert!" "Puh, Sonne? Zu hell!" "Endlich mal Sonne!" "Sonne? Na gut, ok!" "Sonne brennt, aua!" "Zu viel Sonne, echt?" "Sonne? Ich blend!" "Klarer Himmel? Puh!" "Sonne, mach Pause!" "Strahlen? Oh, Mann!" "Sonne? Zu heiss!" "Himmel klar? Argh!" "Sonne, chill mal!" "Zu hell da draussen!" "Sonne? Echt jetzt?" "Blauer Himmel? Boah!")
        else
            case $WEATHER_CODE in
                0) WEATHER_EMOJI="‚òÄÔ∏è"
                   WEATHER_JOKE_ARRAY=("Sonne! Sommerfeeling!" "Blauer Himmel, yeah!" "Sonnenbrille raus!" "Sonne lacht, nice!" "Hamburg glitzert!" "Puh, Sonne? Zu hell!" "Endlich mal Sonne!" "Sonne? Na gut, ok!" "Sonne brennt, aua!" "Zu viel Sonne, echt?" "Sonne? Ich blend!" "Klarer Himmel? Puh!" "Sonne, mach Pause!" "Strahlen? Oh, Mann!" "Sonne? Zu heiss!" "Himmel klar? Argh!" "Sonne, chill mal!" "Zu hell da draussen!" "Sonne? Echt jetzt?" "Blauer Himmel? Boah!");;
                1|2|3) WEATHER_EMOJI="‚òÅÔ∏è"
                        WEATHER_JOKE_ARRAY=("Wolken? Grau hier!" "Himmel halb voll!" "Mal Sonne, mal nicht!" "Wolkenparade!" "Grau, aber gem√ºtlich!" "Schon wieder Wolken?" "Wolken, echt jetzt?" "Himmel, entscheide dich!" "Grau? Langweilig!" "Wolken? Nervig!" "Mal klar, mal grau?" "Wolken? Oh, nein!" "Himmel, was los?" "Grau? Echt jetzt?" "Wolken, geht weg!" "Mal Sonne? Bitte!" "Himmel, mach klar!" "Wolken? So √∂de!" "Grau? Ich heul!" "Wolken? Argh!");;
                45|48) WEATHER_EMOJI="üå´Ô∏è"
                       WEATHER_JOKE_ARRAY=("Nebel? Wo bin ich?" "Alles verschwommen!" "Nebel-Superman!" "Sichtweite null!" "Nebel wie im Film!" "Nebel? Ich seh nix!" "Nebel, echt nervig!" "Wo ist der Himmel?" "Nebel? Echt jetzt?" "Sicht weg? Argh!" "Nebel, verschwinde!" "Alles grau? Boah!" "Nebel? Oh, Mann!" "Wo geht‚Äôs lang?" "Nebel? So √§tzend!" "Sicht null? Puh!" "Nebel, echt l√§stig!" "Himmel weg? Mist!" "Nebel? Ich geb auf!" "Wo bin ich? Hilfe!");;
                61|63|65) WEATHER_EMOJI="üåßÔ∏è"
                          WEATHER_JOKE_ARRAY=("Regen? Schirm her!" "Nass da draussen!" "Platsch, nass!" "Regen tanzt!" "Gummistiefel an!" "Schon wieder Regen?" "Regen? Echt jetzt?" "Nass? Oh, Mann!" "Wasser? Ich rust!" "Regen, h√∂r auf!" "Nass? So √§tzend!" "Schirm? Wo ist er?" "Regen? Argh!" "Platsch? Echt jetzt?" "Nasses Hamburg?" "Regen? Ich heul!" "Wasser √ºberall!" "Schirm her, schnell!" "Regen? So nervig!" "Nass? Puh, Mist!");;
                71|73|75) WEATHER_EMOJI="‚ùÑÔ∏è"
                          WEATHER_JOKE_ARRAY=("Brr, CPU w√§rmt mich!" "Schnee! Kalt hier!" "Winter is coming!" "Schneeflocken-Party!" "Frostig, brr!" "Schnee? Mir ist kalt!" "Schnee, echt jetzt?" "K√§lte? I bibber!" "Schnee? Oh, nein!" "Frost? Echt l√§stig!" "Schnee? Argh!" "Kalt? Ich frier!" "Winter? So kalt!" "Schnee? Puh, kalt!" "Frost? Nervig!" "Schnee, geh weg!" "K√§lte? Hilfe!" "Schnee? Zu viel!" "Winter? Boah!" "Brr, zu kalt!");;
                *) WEATHER_EMOJI="ü§î"
                   WEATHER_JOKE_ARRAY=("Wetter? R√§tsel!" "Wetter? R√§tsel!" "Wetter? R√§tsel!" "Wetter? R√§tsel!" "Wetter? R√§tsel!" "Wetter? R√§tsel!" "Wetter? R√§tsel!" "Wetter? R√§tsel!" "Wetter? R√§tsel!" "Wetter? R√§tsel!" "Wetter? R√§tsel!" "Wetter? R√§tsel!" "Wetter? R√§tsel!" "Wetter? R√§tsel!" "Wetter? R√§tsel!" "Wetter? R√§tsel!" "Wetter? R√§tsel!" "Wetter? R√§tsel!" "Wetter? R√§tsel!" "Wetter? R√§tsel!");;
            esac
            WEATHER_JOKE=${WEATHER_JOKE_ARRAY[$((RANDOM % ${#WEATHER_JOKE_ARRAY[@]}))]}
        fi
    else
        WEATHER_JOKE=$HARDWARE_JOKE
    fi
fi

# --- 4. Temperaturtrend ---
if [ "$CURRENT_TEMP" != "N/A" ] && [ -f "$LAST_TEMP_FILE" ]; then
    LAST_TEMP=$(cat "$LAST_TEMP_FILE")
    TEMP_DIFF=$(echo "$CURRENT_TEMP - $LAST_TEMP" | bc)
    if [ $(echo "$TEMP_DIFF > 0.5" | bc) -eq 1 ]; then
        TREND="‚Üë"
        TREND_JOKE_ARRAY=("Heisser wird‚Äôs!" "W√§rme rauf!" "Sommer kommt!" "Temperatur hoch!" "Aufheizen, los!" "Wird heisser? Puh!" "W√§rme? Oh, Mann!" "Sommer-Alarm!" "Heiss? Echt jetzt?" "Temperatur rauf?" "W√§rme? Argh!" "Sommer? Boah!" "Heisser? Nervig!" "Aufheizen? Mist!" "W√§rme? Zu viel!" "Sommer? Hilfe!" "Heiss? So √§tzend!" "Temperatur? Puh!" "W√§rme rauf? Argh!" "Heisser? Oh, nein!")
        TREND_JOKE=${TREND_JOKE_ARRAY[$((RANDOM % ${#TREND_JOKE_ARRAY[@]}))]}
    elif [ $(echo "$TEMP_DIFF < -0.5" | bc) -eq 1 ]; then
        TREND="‚Üì"
        TREND_JOKE_ARRAY=("K√ºhler wird‚Äôs!" "Abk√ºhlung, nice!" "K√§lte naht!" "Temperatur runter!" "Frost-Alarm!" "K√§lter? Brr!" "Abk√ºhlen? Gut!" "K√§lte? Oh, nein!" "K√ºhler? Echt jetzt?" "Frost? Nervig!" "K√§lte? Puh!" "Abk√ºhlen? Yeah!" "K√§lter? Argh!" "Frost? Oh, Mann!" "K√ºhle? Boah!" "K√§lte? Hilfe!" "Temperatur runter?" "K√§lter? So kalt!" "Abk√ºhlen? Nice!" "Frost? Echt jetzt?")
        TREND_JOKE=${TREND_JOKE_ARRAY[$((RANDOM % ${#TREND_JOKE_ARRAY[@]}))]}
    else
        TREND=""
        TREND_JOKE=""
    fi
else
    TREND=""
    TREND_JOKE=""
fi
[ "$CURRENT_TEMP" != "N/A" ] && echo "$CURRENT_TEMP" > "$LAST_TEMP_FILE"

# --- 5. Zuf√§llige witzige Laune (100 % f√ºr Nacht, Wochenende, Montag vormittag) ---
if [ "$LAUNE_STATE" = "Nacht" ]; then
    LAUNE_ARRAY=("Nachtschicht! Argh!" "Sterne gucken? Puh!" "Licht aus, bitte!" "Schlummerzeit? Echt?" "Mond an, los!" "Nacht? So m√ºde!" "Sterne? Na gut!" "Schlafen? Nein!" "Dunkel? Oh, Mann!" "Nacht? Echt jetzt?" "Mond? Zu hell!" "Dunkel? Nervig!" "Sterne? Boah!" "Nacht? Ich heul!" "Schlaf? So √§tzend!" "Mond? Na, toll!" "Dunkel? Hilfe!" "Nacht? Zzz..." "Sterne? Chill mal!" "Licht aus? Los!")
    LAUNE_EMOJI="üò¥"
elif [ "$LAUNE_STATE" = "Wochenende" ]; then
    LAUNE_ARRAY=("Chill-Modus! Yeah!" "Partyzeit! Los!" "Sofa ruft! Nice!" "Wochenende? Cool!" "Entspann dich!" "Faul sein? Nice!" "Frei? Endlich!" "Ruhe, bitte!" "Sofa? Oh, yeah!" "Chill? Na, super!" "Party? Argh!" "Frei? Echt jetzt?" "Ruhe? Ja, bitte!" "Sofa? Nervig!" "Wochenende? Puh!" "Chill? Boah!" "Frei? So nice!" "Entspann? Los!" "Sofa? Echt jetzt?" "Party? Oh, Mann!")
    LAUNE_EMOJI="üéâ"
elif [ "$LAUNE_STATE" = "MontagVormittag" ]; then
    LAUNE_ARRAY=("Montag? Kaffee her!" "Wochenstart? Argh!" "M√ºde? Echt jetzt?" "Kaffee? Schnell!" "Montag? Oh, nein!" "M√ºdigkeit? Hilfe!" "Wochenanfang? Puh!" "Kaffee? Brauch ich!" "Montag? So √§tzend!" "M√ºde? Boah!" "Start? Nervig!" "Kaffee? Jetzt!" "Montag? Ich heul!" "Wochenstart? Mist!" "M√ºde? Zu fr√ºh!" "Kaffee? Oh, Mann!" "Montag? Langweilig!" "Wochenanfang? Boah!" "M√ºde? Na, toll!" "Start? Echt jetzt?")
    LAUNE_EMOJI="‚òï"
else
    LAUNE=""
    LAUNE_EMOJI=""
fi
if [ -n "$LAUNE" ]; then
    LAUNE=${LAUNE_ARRAY[$((RANDOM % ${#LAUNE_ARRAY[@]}))]}
fi

# --- 6. Nachricht zusammenstellen ---
if [ -n "$HARDWARE_JOKE" ]; then
    WEATHER_JOKE=$HARDWARE_JOKE
fi
MESSAGE="[$UHRZEIT] $LAUNE_EMOJI $LAUNE $WEATHER_EMOJI $TEMP_BASE $TREND $SWEAT_EMOJI $TREND_JOKE - $WEATHER_JOKE [$CPU_TEMP_STR üî• $CPU_JOKE]"

# Zeichenanzahl pr√ºfen (<200 f√ºr Meshtastic)
MESSAGE_LENGTH=${#MESSAGE}
if [ $MESSAGE_LENGTH -gt 200 ]; then
    MESSAGE="[$UHRZEIT] $WEATHER_EMOJI $TEMP_BASE, $CPU_TEMP_STR - $WEATHER_JOKE"
fi

# --- 7. Meshtastic senden (Main Channel, Index 0) ---
if ! meshtastic --port "$MESHTASTIC_PORT" --sendtext "$MESSAGE" 2>>"$DEBUG_FILE"; then
    echo "[$TIMESTAMP] Fehler beim Senden (Port: $MESHTASTIC_PORT, L√§nge: ${#MESSAGE})" >> "$LOG_FILE"
fi

# --- 8. Logging ---
echo "[$TIMESTAMP] $MESSAGE" >> "$LOG_FILE"

# Ende
exit 0
